<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NBA Reporter Rankings | HoopsHype</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Inter', -apple-system, sans-serif; background: #f5f5f5; color: #333; line-height: 1.5; }
        
        .header {
            background: white; border-bottom: 3px solid #e74c3c; padding: 20px 0;
            position: sticky; top: 0; z-index: 100; box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .header-content { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
        .logo { font-size: 24px; font-weight: 700; color: #e74c3c; margin-bottom: 16px; }
        .logo span { color: #333; }

        .stats-banner { display: flex; gap: 30px; padding: 16px 0; border-bottom: 1px solid #eee; margin-bottom: 16px; flex-wrap: wrap; }
        .stat-item { text-align: center; }
        .stat-value { font-size: 28px; font-weight: 700; color: #e74c3c; }
        .stat-label { font-size: 12px; color: #666; text-transform: uppercase; }

        .nav-row { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; }
        .nav-tabs { display: flex; gap: 8px; flex-wrap: wrap; }
        .nav-tab {
            padding: 10px 20px; border: 1px solid #ddd; background: white;
            color: #666; font-size: 13px; font-weight: 500; cursor: pointer;
            border-radius: 6px; transition: all 0.2s;
        }
        .nav-tab:hover { border-color: #e74c3c; color: #e74c3c; }
        .nav-tab.active { background: #e74c3c; border-color: #e74c3c; color: white; }

        .time-filter { display: flex; gap: 4px; flex-wrap: wrap; }
        .time-btn {
            padding: 8px 14px; border: 1px solid #ddd; background: white;
            color: #666; font-size: 12px; cursor: pointer; border-radius: 4px; transition: all 0.2s;
        }
        .time-btn:hover { border-color: #e74c3c; }
        .time-btn.active { background: #e74c3c; border-color: #e74c3c; color: white; }

        .main { max-width: 1200px; margin: 0 auto; padding: 30px 20px; }
        .section-title { font-size: 20px; font-weight: 600; margin-bottom: 20px; color: #333; }

        .card {
            background: white; border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06); overflow: hidden; margin-bottom: 20px;
        }
        .card-header {
            padding: 16px 20px; border-bottom: 1px solid #eee;
            font-weight: 600; color: #333; display: flex; align-items: center; gap: 10px;
        }

        .reporter-row {
            display: flex; align-items: center; padding: 16px 20px;
            border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s;
        }
        .reporter-row:hover { background: #fafafa; }
        .reporter-row:last-child { border-bottom: none; }

        .rank {
            width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
            font-weight: 700; font-size: 14px; margin-right: 16px; border-radius: 50%; flex-shrink: 0;
        }
        .rank-1 { background: linear-gradient(135deg, #f5a623, #f7931a); color: white; }
        .rank-2 { background: linear-gradient(135deg, #c0c0c0, #a8a8a8); color: white; }
        .rank-3 { background: linear-gradient(135deg, #cd7f32, #b8860b); color: white; }
        .rank-default { background: #f0f0f0; color: #666; }

        .reporter-info { flex: 1; min-width: 0; }
        .reporter-name { font-weight: 600; font-size: 15px; color: #333; }
        .reporter-outlet { font-size: 13px; color: #888; }

        .reporter-stat { text-align: right; }
        .reporter-stat-value { font-size: 20px; font-weight: 700; color: #e74c3c; }
        .reporter-stat-label { font-size: 11px; color: #888; text-transform: uppercase; }

        .grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        @media (max-width: 900px) { .grid-2, .grid-3 { grid-template-columns: 1fr; } }

        .profile-page { display: none; }
        .profile-page.active { display: block; }

        .profile-header-card {
            background: white; border-radius: 12px; padding: 30px;
            margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.06);
        }
        .profile-top { display: flex; align-items: flex-start; gap: 24px; margin-bottom: 24px; flex-wrap: wrap; }
        .profile-avatar {
            width: 80px; height: 80px; border-radius: 50%; background: #e74c3c; color: white;
            display: flex; align-items: center; justify-content: center;
            font-size: 28px; font-weight: 700; flex-shrink: 0;
        }
        .profile-info h1 { font-size: 28px; font-weight: 700; margin-bottom: 4px; }
        .profile-info .outlet { font-size: 16px; color: #666; margin-bottom: 8px; }

        .tier-badge { display: inline-block; padding: 4px 12px; border-radius: 4px; font-size: 12px; font-weight: 600; }
        .tier-1 { background: #e74c3c; color: white; }
        .tier-2 { background: #3498db; color: white; }
        .tier-3 { background: #95a5a6; color: white; }

        .profile-stats-grid { display: grid; grid-template-columns: repeat(6, 1fr); gap: 12px; }
        @media (max-width: 900px) { .profile-stats-grid { grid-template-columns: repeat(3, 1fr); } }

        .profile-stat-box { background: #f8f9fa; padding: 16px; border-radius: 8px; text-align: center; }
        .profile-stat-box .value { font-size: 24px; font-weight: 700; color: #e74c3c; }
        .profile-stat-box .label { font-size: 10px; color: #666; text-transform: uppercase; margin-top: 4px; }

        .back-btn {
            display: inline-flex; align-items: center; gap: 8px; padding: 10px 20px;
            background: white; border: 1px solid #ddd; border-radius: 6px;
            color: #333; font-size: 14px; cursor: pointer; margin-bottom: 20px; transition: all 0.2s;
        }
        .back-btn:hover { border-color: #e74c3c; color: #e74c3c; }
        .back-btn-bottom { margin-top: 20px; margin-bottom: 0; }

        .coverage-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 8px; padding: 16px; }
        .coverage-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 10px 14px; background: #f8f9fa; border-radius: 6px; cursor: pointer;
            transition: all 0.2s;
        }
        .coverage-item:hover { background: #e74c3c; color: white; }
        .coverage-item:hover .count { color: white; }
        .coverage-item .name { font-size: 13px; color: #333; }
        .coverage-item:hover .name { color: white; }
        .coverage-item .count { font-weight: 600; color: #e74c3c; font-size: 13px; }

        .team-coverage-card { background: white; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .team-name { font-weight: 600; font-size: 15px; color: #333; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
        .reporter-mini { display: flex; justify-content: space-between; padding: 6px 0; font-size: 13px; cursor: pointer; }
        .reporter-mini:hover { color: #e74c3c; }
        .reporter-mini .count { color: #e74c3c; font-weight: 600; }

        /* Heatmap - Desktop */
        .heatmap-container { overflow-x: auto; }
        .heatmap { display: table; border-collapse: collapse; font-size: 11px; width: 100%; }
        .heatmap th, .heatmap td { padding: 6px 8px; text-align: center; border: 1px solid #eee; white-space: nowrap; }
        .heatmap th { background: #f5f5f5; font-weight: 600; position: sticky; top: 0; }
        .heatmap td:first-child { position: sticky; left: 0; background: white; font-weight: 500; text-align: left; z-index: 1; min-width: 140px; }
        .heatmap td { min-width: 40px; }

        .heat-0 { background: #fff; color: #ccc; }
        .heat-1 { background: #fff5f5; }
        .heat-2 { background: #fed7d7; }
        .heat-3 { background: #feb2b2; }
        .heat-4 { background: #fc8181; }
        .heat-5 { background: #f56565; color: white; }

        /* Heatmap - Mobile */
        .heatmap-mobile { display: none; }
        @media (max-width: 768px) {
            .heatmap-container { display: none; }
            .heatmap-mobile { display: block; }
            .heatmap-card { background: #f8f9fa; border-radius: 8px; padding: 12px; margin-bottom: 12px; }
            .heatmap-card-header { font-weight: 600; font-size: 14px; margin-bottom: 8px; color: #333; }
            .heatmap-card-teams { display: flex; flex-wrap: wrap; gap: 6px; }
            .heatmap-team-badge { 
                padding: 4px 8px; border-radius: 4px; font-size: 11px; 
                display: inline-flex; align-items: center; gap: 4px;
            }
            .heatmap-team-badge .team-abbr { font-weight: 600; }
            .heatmap-team-badge .team-count { opacity: 0.8; }
        }

        .loading { padding: 40px; text-align: center; color: #888; }
        .view-section { display: none; }
        .view-section.active { display: block; }

        .timeline-container { padding: 20px; }
        .timeline-chart { display: flex; align-items: flex-end; gap: 2px; height: 120px; margin-bottom: 8px; }
        .timeline-bar { flex: 1; background: #e74c3c; border-radius: 2px 2px 0 0; min-width: 8px; transition: all 0.2s; position: relative; }
        .timeline-bar:hover { background: #c0392b; }
        .timeline-bar:hover::after {
            content: attr(data-tooltip); position: absolute; bottom: 100%; left: 50%;
            transform: translateX(-50%); background: #333; color: white; padding: 4px 8px;
            border-radius: 4px; font-size: 11px; white-space: nowrap; z-index: 10;
        }
        .timeline-labels { display: flex; gap: 2px; font-size: 10px; color: #888; }
        .timeline-labels span { flex: 1; text-align: center; min-width: 8px; }

        .period-note { font-size: 12px; color: #888; margin-top: 8px; text-align: center; }

        /* Modal */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;
        }
        .modal-overlay.active { display: flex; }
        .modal {
            background: white; border-radius: 12px; max-width: 600px; width: 90%; max-height: 80vh;
            overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
        }
        .modal-header {
            padding: 20px; border-bottom: 1px solid #eee; display: flex;
            justify-content: space-between; align-items: center;
        }
        .modal-header h2 { font-size: 18px; font-weight: 600; }
        .modal-close { background: none; border: none; font-size: 24px; cursor: pointer; color: #888; }
        .modal-close:hover { color: #333; }
        .modal-body { padding: 20px; overflow-y: auto; max-height: calc(80vh - 80px); }
        .rumor-item { padding: 12px; background: #f8f9fa; border-radius: 8px; margin-bottom: 10px; }
        .rumor-date { font-size: 11px; color: #888; margin-bottom: 4px; }
        .rumor-text { font-size: 13px; line-height: 1.5; }
        .rumor-link { color: #e74c3c; text-decoration: none; font-size: 12px; margin-top: 6px; display: inline-block; }
        .no-rumors { color: #888; text-align: center; padding: 20px; }
    </style>
</head>
<body>
    <header class="header">
        <div class="header-content">
            <div class="logo">REPORTER <span>RANKINGS</span></div>
            
            <div class="stats-banner">
                <div class="stat-item"><div class="stat-value" id="stat-reporters">-</div><div class="stat-label">Reporters</div></div>
                <div class="stat-item"><div class="stat-value" id="stat-rumors">-</div><div class="stat-label">Rumors Tracked</div></div>
                <div class="stat-item"><div class="stat-value" id="stat-outlets">-</div><div class="stat-label">Outlets</div></div>
                <div class="stat-item"><div class="stat-value" id="stat-period">-</div><div class="stat-label">Current Period</div></div>
            </div>

            <div class="nav-row">
                <div class="nav-tabs">
                    <button class="nav-tab active" data-view="leaderboard">Leaderboard</button>
                    <button class="nav-tab" data-view="teams">By Team</button>
                    <button class="nav-tab" data-view="players">By Player</button>
                    <button class="nav-tab" data-view="heatmap">Heatmap</button>
                    <button class="nav-tab" data-view="outlets">Outlets</button>
                </div>
                <div class="time-filter">
                    <button class="time-btn" data-days="7">Week</button>
                    <button class="time-btn" data-days="30">Month</button>
                    <button class="time-btn active" data-days="90">3 Mo</button>
                    <button class="time-btn" data-days="180">6 Mo</button>
                    <button class="time-btn" data-days="365">Year</button>
                    <button class="time-btn" data-days="0">All</button>
                </div>
            </div>
        </div>
    </header>

    <main class="main">
        <div id="main-content">
            <section id="leaderboard" class="view-section active">
                <div class="grid-2">
                    <div class="card"><div class="card-header">üìä Top 50 Reporters</div><div id="leaderboard-list" class="loading">Loading...</div></div>
                    <div class="card"><div class="card-header">üìà Trending Up</div><div id="trending-list" class="loading">Loading...</div></div>
                </div>
            </section>

            <section id="teams" class="view-section">
                <h2 class="section-title">Top 5 Reporters for Each Team</h2>
                <div id="teams-grid" class="grid-3 loading">Loading...</div>
            </section>

            <section id="players" class="view-section">
                <h2 class="section-title">Top 5 Reporters for Most Mentioned Players</h2>
                <div id="players-grid" class="grid-3 loading">Loading...</div>
            </section>

            <section id="heatmap" class="view-section">
                <h2 class="section-title">Reporter √ó Team Coverage Heatmap</h2>
                <div class="card">
                    <div class="heatmap-container"><table class="heatmap" id="heatmap-table"></table></div>
                    <div class="heatmap-mobile" id="heatmap-mobile"></div>
                </div>
            </section>

            <section id="outlets" class="view-section">
                <h2 class="section-title">Media Outlets</h2>
                <div class="card"><div class="card-header">üì∞ Top Outlets by Volume</div><div id="outlets-list" class="loading">Loading...</div></div>
            </section>
        </div>

        <div id="profile-page" class="profile-page">
            <button class="back-btn" onclick="closeProfile()">‚Üê Back to Rankings</button>
            
            <div class="profile-header-card">
                <div class="profile-top">
                    <div class="profile-avatar" id="profile-avatar"></div>
                    <div class="profile-info">
                        <h1 id="profile-name"></h1>
                        <div class="outlet" id="profile-outlet"></div>
                        <span class="tier-badge" id="profile-tier"></span>
                    </div>
                </div>
                <div class="profile-stats-grid">
                    <div class="profile-stat-box"><div class="value" id="profile-week">0</div><div class="label">Week</div></div>
                    <div class="profile-stat-box"><div class="value" id="profile-month">0</div><div class="label">Month</div></div>
                    <div class="profile-stat-box"><div class="value" id="profile-3mo">0</div><div class="label">3 Months</div></div>
                    <div class="profile-stat-box"><div class="value" id="profile-6mo">0</div><div class="label">6 Months</div></div>
                    <div class="profile-stat-box"><div class="value" id="profile-year">0</div><div class="label">Year</div></div>
                    <div class="profile-stat-box"><div class="value" id="profile-total">0</div><div class="label">All-Time</div></div>
                </div>
                <div class="period-note">Use the time filter buttons above to change the period. Click on any team/player/agent below to see related rumors.</div>
            </div>

            <div class="card">
                <div class="card-header">üìà Activity Over Time</div>
                <div class="timeline-container">
                    <div class="timeline-chart" id="timeline-chart"></div>
                    <div class="timeline-labels" id="timeline-labels"></div>
                </div>
            </div>

            <div class="grid-3" id="profile-coverage-grid">
                <div class="card"><div class="card-header">üèÄ Top 30 Teams</div><div id="profile-teams-list"></div></div>
                <div class="card"><div class="card-header">‚≠ê Top 30 Players</div><div id="profile-players-list"></div></div>
                <div class="card"><div class="card-header">ü§ù Top 10 Agents</div><div id="profile-agents-list"></div></div>
            </div>

            <button class="back-btn back-btn-bottom" onclick="closeProfile()">‚Üê Back to Rankings</button>
        </div>
    </main>

    <!-- Modal for showing rumors -->
    <div class="modal-overlay" id="rumor-modal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title">Rumors</h2>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body" id="modal-body"></div>
        </div>
    </div>

    <script src="reporter_data.js"></script>
    <script>
        // =============================================
        // CONSTANTS
        // =============================================
        
        const NBA_TEAMS = [
            "Atlanta Hawks", "Boston Celtics", "Brooklyn Nets", "Charlotte Hornets", 
            "Chicago Bulls", "Cleveland Cavaliers", "Dallas Mavericks", "Denver Nuggets", 
            "Detroit Pistons", "Golden State Warriors", "Houston Rockets", "Indiana Pacers",
            "Los Angeles Clippers", "Los Angeles Lakers", "Memphis Grizzlies", "Miami Heat", 
            "Milwaukee Bucks", "Minnesota Timberwolves", "New Orleans Pelicans", "New York Knicks", 
            "Oklahoma City Thunder", "Orlando Magic", "Philadelphia 76ers", "Phoenix Suns",
            "Portland Trail Blazers", "Sacramento Kings", "San Antonio Spurs", 
            "Toronto Raptors", "Utah Jazz", "Washington Wizards"
        ];
        
        const TEAM_SHORT_TO_FULL = {
            "Hawks": "Atlanta Hawks", "Celtics": "Boston Celtics", "Nets": "Brooklyn Nets",
            "Hornets": "Charlotte Hornets", "Bulls": "Chicago Bulls", "Cavaliers": "Cleveland Cavaliers",
            "Mavericks": "Dallas Mavericks", "Nuggets": "Denver Nuggets", "Pistons": "Detroit Pistons",
            "Warriors": "Golden State Warriors", "Rockets": "Houston Rockets", "Pacers": "Indiana Pacers",
            "Clippers": "Los Angeles Clippers", "Lakers": "Los Angeles Lakers", "Grizzlies": "Memphis Grizzlies",
            "Heat": "Miami Heat", "Bucks": "Milwaukee Bucks", "Timberwolves": "Minnesota Timberwolves",
            "Pelicans": "New Orleans Pelicans", "Knicks": "New York Knicks", "Thunder": "Oklahoma City Thunder",
            "Magic": "Orlando Magic", "76ers": "Philadelphia 76ers", "Sixers": "Philadelphia 76ers",
            "Suns": "Phoenix Suns", "Trail Blazers": "Portland Trail Blazers", "Blazers": "Portland Trail Blazers",
            "Kings": "Sacramento Kings", "Spurs": "San Antonio Spurs", "Raptors": "Toronto Raptors", 
            "Jazz": "Utah Jazz", "Wizards": "Washington Wizards"
        };

        const TEAM_ABBREV = {
            "Atlanta Hawks": "ATL", "Boston Celtics": "BOS", "Brooklyn Nets": "BKN",
            "Charlotte Hornets": "CHA", "Chicago Bulls": "CHI", "Cleveland Cavaliers": "CLE",
            "Dallas Mavericks": "DAL", "Denver Nuggets": "DEN", "Detroit Pistons": "DET",
            "Golden State Warriors": "GSW", "Houston Rockets": "HOU", "Indiana Pacers": "IND",
            "Los Angeles Clippers": "LAC", "Los Angeles Lakers": "LAL", "Memphis Grizzlies": "MEM",
            "Miami Heat": "MIA", "Milwaukee Bucks": "MIL", "Minnesota Timberwolves": "MIN",
            "New Orleans Pelicans": "NOP", "New York Knicks": "NYK", "Oklahoma City Thunder": "OKC",
            "Orlando Magic": "ORL", "Philadelphia 76ers": "PHI", "Phoenix Suns": "PHX",
            "Portland Trail Blazers": "POR", "Sacramento Kings": "SAC", "San Antonio Spurs": "SAS",
            "Toronto Raptors": "TOR", "Utah Jazz": "UTA", "Washington Wizards": "WAS"
        };

        // Non-players to exclude
        const NON_PLAYERS = new Set([
            "team usa", "usa basketball", "g league", "nba", "all-star", "hall of fame", 
            "olympics", "fiba", "eurobasket", "world cup", "summer league", "social media",
            "free agency", "trade", "draft", "new orleans hornets", "training camp",
            // Commissioners/Executives
            "david stern", "adam silver", "billy hunter", "mark cuban", "mat ishbia",
            // Coaches
            "doc rivers", "brad stevens", "gregg popovich", "brett brown", "rick carlisle",
            "erik spoelstra", "phil jackson", "mike d'antoni", "dwane casey", "frank vogel",
            "steve kerr", "tyronn lue", "tom thibodeau", "mike budenholzer", "nick nurse",
            "quin snyder", "monty williams", "jason kidd", "ime udoka", "jb bickerstaff",
            "mark daigneault", "doug christie", "scott brooks", "steve nash",
            "pat riley", "david blatt",
            // GMs/Executives  
            "bob myers", "sam presti", "daryl morey", "masai ujiri", "rob pelinka",
            "james jones", "koby altman",
            // Agents
            "mark bartelstein", "rich paul", "jeff schwartz", "aaron mintz", "bill duffy",
            "leon rose", "dan fegan", "arn tellem", "aaron goodwin", "happy walters"
        ].map(s => s.toLowerCase()));

        // Excluded "reporters" (PR accounts, teams, players, non-reporters)
        const EXCLUDED_REPORTERS = new Set([
            // PR accounts
            "@mrbuckbucknba", "@nbapr", "@ohnohedidnt24", "@hornetspr", "@espnstatsinfo",
            "@trailblazerspr", "@trailblazerpr", "@pelicansnba", "@magic_pr", "@fullcourtpass",
            "@kingjames", "@nba__courtside", "@hellowelcomepod", "@wwe",
            "mrbuckbucknba", "nbapr", "ohnohedidnt24", "hornetspr", "espnstatsinfo",
            "trailblazerspr", "trailblazerpr", "pelicansnba", "magic_pr", "fullcourtpass",
            "mavs pr", "grizzlies pr", "timberwolves pr", "heat centel",
            // Teams listed as reporters
            "atlanta hawks", "chicago bulls", "indiana pacers", "milwaukee bucks",
            "utah jazz", "miami heat",
            // Players listed as reporters
            "carmelo anthony", "chris paul", "dwight howard", "giannis antetokounmpo",
            "dwyane wade", "bradley beal", "magic johnson", "isaiah thomas", "john wall",
            "damian lillard", "cade cunningham", "tyrese haliburton", "tyrese maxey",
            "austin reaves", "ben simmons", "norman powell",
            "kobe bryant", "kevin love", "rudy gobert", "donovan mitchell", "trae young",
            "kevin durant", "joel embiid", "draymond green", "kyrie irving", "steve nash",
            "pau gasol", "andre iguodala", "kyle kuzma",
            "ricky rubio", "patrick beverley", "ja morant", "jamal crawford",
            // Coaches/Others
            "steve kerr", "mat ishbia", "kevin hart", "doug christie", "training camp",
            // Generic
            "social media", "unknown", "n/a", "clutch points"
        ].map(s => s.toLowerCase()));

        // Excluded outlets
        const EXCLUDED_OUTLETS = new Set([
            "youtube", "reddit", "twitter", "x.com", "instagram", "facebook", 
            "tiktok", "threads", "unknown", "@kcjhoop"
        ].map(s => s.toLowerCase()));

        // Handle to reporter name mapping
        const HANDLE_TO_NAME = {
            "kcjhoop": "K.C. Johnson"
        };

        // Reporter to outlet mapping
        const REPORTER_TO_OUTLET = {
            "jorge sierra": "HoopsHype",
            "michael scotto": "HoopsHype"
        };

        // Outlet normalization
        const OUTLET_NORMALIZE = {
            "espn.com": "ESPN", "ESPN.com": "ESPN",
            "hoopshype": "HoopsHype", "Hoopshype": "HoopsHype"
        };

        // =============================================
        // STATE
        // =============================================
        
        let REPORTERS = [];
        let OUTLETS = [];
        let currentDays = 90; // Default to 3 months
        let currentView = 'leaderboard';
        let currentProfileId = null;

        // =============================================
        // HELPER FUNCTIONS
        // =============================================

        function getFilteredCount(byDate, days) {
            if (!byDate || Object.keys(byDate).length === 0) return 0;
            if (days === 0) return Object.values(byDate).reduce((sum, c) => sum + c, 0);
            
            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);
            const cutoffStr = cutoff.toISOString().split('T')[0];

            let total = 0;
            for (const [date, count] of Object.entries(byDate)) {
                if (date >= cutoffStr) total += count;
            }
            return total;
        }

        function getProportionalCount(totalCount, byDate, days) {
            if (days === 0) return totalCount;
            const allTimeTotal = Object.values(byDate || {}).reduce((sum, c) => sum + c, 0);
            if (allTimeTotal === 0) return 0;
            const filteredTotal = getFilteredCount(byDate, days);
            return Math.round(totalCount * (filteredTotal / allTimeTotal));
        }

        function isValidReporter(name) {
            if (!name) return false;
            const nameLower = name.toLowerCase().trim();
            if (EXCLUDED_REPORTERS.has(nameLower)) return false;
            if (nameLower.startsWith('@') && nameLower.length < 4) return false;
            for (const team of NBA_TEAMS) {
                if (nameLower === team.toLowerCase()) return false;
            }
            return true;
        }

        function isValidPlayer(name) {
            if (!name) return false;
            const nameLower = name.toLowerCase().trim();
            if (NON_PLAYERS.has(nameLower)) return false;
            if (EXCLUDED_REPORTERS.has(nameLower)) return false;
            for (const short of Object.keys(TEAM_SHORT_TO_FULL)) {
                if (nameLower === short.toLowerCase()) return false;
            }
            for (const team of NBA_TEAMS) {
                if (nameLower === team.toLowerCase()) return false;
            }
            return true;
        }

        function isValidOutlet(name) {
            if (!name) return false;
            return !EXCLUDED_OUTLETS.has(name.toLowerCase().trim());
        }

        function normalizeTeamName(team) {
            return TEAM_SHORT_TO_FULL[team] || team;
        }

        function normalizeOutletName(outlet) {
            if (!outlet) return outlet;
            const lower = outlet.toLowerCase();
            for (const [key, val] of Object.entries(OUTLET_NORMALIZE)) {
                if (key.toLowerCase() === lower) return val;
            }
            return outlet;
        }

        function normalizeReporterName(name) {
            if (!name) return name;
            const handle = name.replace('@', '').toLowerCase();
            return HANDLE_TO_NAME[handle] || name;
        }

        function getReporterOutlet(name, defaultOutlet) {
            const nameLower = name.toLowerCase();
            if (REPORTER_TO_OUTLET[nameLower]) return REPORTER_TO_OUTLET[nameLower];
            return normalizeOutletName(defaultOutlet);
        }

        // =============================================
        // INITIALIZATION
        // =============================================

        function initializeData() {
            if (typeof REPORTER_DATA === 'undefined') return false;

            REPORTERS = REPORTER_DATA.reporters
                .filter(r => isValidReporter(r.name))
                .map((r, i) => {
                    const name = normalizeReporterName(r.name);
                    
                    const filteredByPlayer = {};
                    for (const [playerName, count] of Object.entries(r.by_player || {})) {
                        if (isValidPlayer(playerName)) {
                            filteredByPlayer[playerName] = count;
                        }
                    }
                    
                    const normalizedByTeam = {};
                    for (const [team, count] of Object.entries(r.by_team || {})) {
                        const fullName = normalizeTeamName(team);
                        if (NBA_TEAMS.includes(fullName)) {
                            normalizedByTeam[fullName] = (normalizedByTeam[fullName] || 0) + count;
                        }
                    }

                    return {
                        id: r.id || `reporter_${i}`,
                        name,
                        outlet: getReporterOutlet(name, r.outlet),
                        tier: r.tier || 3,
                        avatar: r.avatar || name.replace('@', '').substring(0, 2).toUpperCase(),
                        total: r.total || 0,
                        byTopic: r.by_topic || {},
                        byPlayer: filteredByPlayer,
                        byTeam: normalizedByTeam,
                        byAgent: r.by_agent || {},
                        byDate: r.by_date || {},
                        recentRumors: r.recent_rumors || []
                    };
                });

            // Merge and filter outlets
            const outletMap = {};
            for (const o of (REPORTER_DATA.outlets || [])) {
                const name = normalizeOutletName(o.name);
                if (!isValidOutlet(name)) continue;
                if (!outletMap[name]) outletMap[name] = { name, total: 0, byDate: {} };
                outletMap[name].total += o.total || 0;
                for (const [date, count] of Object.entries(o.by_date || {})) {
                    outletMap[name].byDate[date] = (outletMap[name].byDate[date] || 0) + count;
                }
            }
            OUTLETS = Object.values(outletMap);

            document.getElementById('stat-reporters').textContent = REPORTERS.length.toLocaleString();
            document.getElementById('stat-rumors').textContent = (REPORTER_DATA.processed_rumors || 0).toLocaleString();
            document.getElementById('stat-outlets').textContent = OUTLETS.length.toLocaleString();
            updatePeriodLabel();
            return true;
        }

        function updatePeriodLabel() {
            const labels = { 7: 'Week', 30: 'Month', 90: '3 Months', 180: '6 Months', 365: 'Year', 0: 'All Time' };
            document.getElementById('stat-period').textContent = labels[currentDays] || 'All Time';
        }

        // =============================================
        // FILTERING
        // =============================================

        function getReporterStats() {
            return REPORTERS.map(r => {
                const filteredTotal = getFilteredCount(r.byDate, currentDays);
                let prevTotal = 0;
                if (currentDays > 0 && currentDays <= 180) {
                    const cutoff = new Date(); cutoff.setDate(cutoff.getDate() - currentDays);
                    const cutoffStr = cutoff.toISOString().split('T')[0];
                    const doubleCutoff = new Date(); doubleCutoff.setDate(doubleCutoff.getDate() - (currentDays * 2));
                    const doubleCutoffStr = doubleCutoff.toISOString().split('T')[0];
                    for (const [date, count] of Object.entries(r.byDate || {})) {
                        if (date >= doubleCutoffStr && date < cutoffStr) prevTotal += count;
                    }
                }
                return { ...r, filteredTotal, previousTotal: prevTotal, change: filteredTotal - prevTotal };
            }).filter(r => r.filteredTotal > 0);
        }

        function getOutletStats() {
            return OUTLETS.map(o => ({
                ...o,
                filteredTotal: getFilteredCount(o.byDate, currentDays)
            })).filter(o => o.filteredTotal > 0);
        }

        // =============================================
        // MODAL
        // =============================================

        function showRumorsModal(reporterId, type, name) {
            const reporter = REPORTERS.find(r => r.id === reporterId);
            if (!reporter) return;

            const modal = document.getElementById('rumor-modal');
            const title = document.getElementById('modal-title');
            const body = document.getElementById('modal-body');

            title.textContent = `${reporter.name} on ${name}`;

            // Filter rumors that mention this player/team/agent
            const nameLower = name.toLowerCase();
            const relevantRumors = (reporter.recentRumors || []).filter(r => {
                const text = (r.text || '').toLowerCase();
                const teams = (r.teams || []).map(t => t.toLowerCase());
                const players = (r.players || []).map(p => p.toLowerCase());
                
                if (type === 'team') {
                    return teams.some(t => t.includes(nameLower) || nameLower.includes(t)) || text.includes(nameLower);
                } else if (type === 'player') {
                    return players.some(p => p.includes(nameLower) || nameLower.includes(p)) || text.includes(nameLower);
                } else if (type === 'agent') {
                    return text.includes(nameLower);
                }
                return false;
            });

            if (relevantRumors.length > 0) {
                body.innerHTML = relevantRumors.map(r => `
                    <div class="rumor-item">
                        <div class="rumor-date">${r.date || 'Unknown date'}</div>
                        <div class="rumor-text">${r.text || ''}</div>
                        ${r.source_url ? `<a href="${r.source_url}" target="_blank" class="rumor-link">View source ‚Üí</a>` : ''}
                    </div>
                `).join('');
            } else {
                body.innerHTML = `
                    <div class="no-rumors">
                        <p>No recent rumors found mentioning ${name}.</p>
                        <p style="margin-top: 10px; font-size: 12px;">Note: We only store the 10 most recent rumors per reporter. The full count (${type === 'team' ? reporter.byTeam[name] : type === 'player' ? reporter.byPlayer[name] : reporter.byAgent[name]} total) includes historical data.</p>
                    </div>
                `;
            }

            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('rumor-modal').classList.remove('active');
        }

        // Close modal when clicking outside
        document.getElementById('rumor-modal').addEventListener('click', (e) => {
            if (e.target.id === 'rumor-modal') closeModal();
        });

        // =============================================
        // RENDERING
        // =============================================

        function renderLeaderboard() {
            const stats = getReporterStats().sort((a, b) => b.filteredTotal - a.filteredTotal);
            if (stats.length === 0) {
                document.getElementById('leaderboard-list').innerHTML = '<div class="loading">No data for this period</div>';
                document.getElementById('trending-list').innerHTML = '<div class="loading">No data for this period</div>';
                return;
            }

            document.getElementById('leaderboard-list').innerHTML = stats.slice(0, 50).map((r, i) => `
                <div class="reporter-row" onclick="openProfile('${r.id}')">
                    <div class="rank ${i < 3 ? `rank-${i+1}` : 'rank-default'}">${i + 1}</div>
                    <div class="reporter-info">
                        <div class="reporter-name">${r.name}</div>
                        <div class="reporter-outlet">${r.outlet}</div>
                    </div>
                    <div class="reporter-stat">
                        <div class="reporter-stat-value">${r.filteredTotal.toLocaleString()}</div>
                        <div class="reporter-stat-label">Rumors</div>
                    </div>
                </div>
            `).join('');

            if (currentDays > 0 && currentDays <= 180) {
                const trending = stats.filter(r => r.change > 0).sort((a, b) => b.change - a.change).slice(0, 20);
                document.getElementById('trending-list').innerHTML = trending.length > 0 
                    ? trending.map((r, i) => `
                        <div class="reporter-row" onclick="openProfile('${r.id}')">
                            <div class="rank ${i < 3 ? `rank-${i+1}` : 'rank-default'}">${i + 1}</div>
                            <div class="reporter-info"><div class="reporter-name">${r.name}</div><div class="reporter-outlet">${r.outlet}</div></div>
                            <div class="reporter-stat"><div class="reporter-stat-value" style="color: #27ae60;">+${r.change}</div><div class="reporter-stat-label">vs prev</div></div>
                        </div>
                    `).join('')
                    : '<div class="loading">No trending data</div>';
            } else {
                document.getElementById('trending-list').innerHTML = '<div class="loading">Select Week/Month/3Mo/6Mo to see trending</div>';
            }
        }

        function renderTeams() {
            const stats = getReporterStats();
            const teamReporters = {}; NBA_TEAMS.forEach(team => { teamReporters[team] = []; });

            stats.forEach(r => {
                for (const [team, totalCount] of Object.entries(r.byTeam || {})) {
                    if (teamReporters[team]) {
                        const filteredCount = getProportionalCount(totalCount, r.byDate, currentDays);
                        if (filteredCount > 0) teamReporters[team].push({ ...r, teamCount: filteredCount });
                    }
                }
            });

            document.getElementById('teams-grid').innerHTML = NBA_TEAMS.map(team => {
                const reporters = teamReporters[team].sort((a, b) => b.teamCount - a.teamCount).slice(0, 5);
                return `<div class="team-coverage-card"><div class="team-name">${team}</div>
                    ${reporters.length > 0 ? reporters.map(r => `<div class="reporter-mini" onclick="openProfile('${r.id}')"><span>${r.name}</span><span class="count">${r.teamCount}</span></div>`).join('') : '<div style="color:#888;font-size:13px;">No data</div>'}</div>`;
            }).join('');
            document.getElementById('teams-grid').classList.remove('loading');
        }

        function renderPlayers() {
            const stats = getReporterStats();
            const playerCounts = {};
            stats.forEach(r => {
                for (const [player, totalCount] of Object.entries(r.byPlayer || {})) {
                    const filteredCount = getProportionalCount(totalCount, r.byDate, currentDays);
                    if (filteredCount > 0) playerCounts[player] = (playerCounts[player] || 0) + filteredCount;
                }
            });

            const topPlayers = Object.entries(playerCounts).sort((a, b) => b[1] - a[1]).slice(0, 50).map(([name]) => name);

            document.getElementById('players-grid').innerHTML = topPlayers.map(player => {
                const reporters = stats.filter(r => r.byPlayer && r.byPlayer[player])
                    .map(r => ({ ...r, playerCount: getProportionalCount(r.byPlayer[player], r.byDate, currentDays) }))
                    .filter(r => r.playerCount > 0).sort((a, b) => b.playerCount - a.playerCount).slice(0, 5);
                return `<div class="team-coverage-card"><div class="team-name">${player}</div>
                    ${reporters.length > 0 ? reporters.map(r => `<div class="reporter-mini" onclick="openProfile('${r.id}')"><span>${r.name}</span><span class="count">${r.playerCount}</span></div>`).join('') : '<div style="color:#888;font-size:13px;">No data</div>'}</div>`;
            }).join('');
            document.getElementById('players-grid').classList.remove('loading');
        }

        function renderHeatmap() {
            // Get top 30 reporters by ALL-TIME total, then sort alphabetically for display
            const allStats = REPORTERS.map(r => ({
                ...r,
                allTimeTotal: Object.values(r.byDate || {}).reduce((sum, c) => sum + c, 0)
            })).filter(r => r.allTimeTotal > 0);
            
            const top30 = allStats.sort((a, b) => b.allTimeTotal - a.allTimeTotal).slice(0, 30);
            const stats = top30.sort((a, b) => a.name.localeCompare(b.name));
            const teams = NBA_TEAMS;

            const heatData = stats.map(r => {
                const teamCounts = {};
                teams.forEach(t => { teamCounts[t] = getProportionalCount(r.byTeam?.[t] || 0, r.byDate, currentDays); });
                return { reporter: r, teamCounts };
            });

            let maxCount = 0;
            heatData.forEach(d => { Object.values(d.teamCounts).forEach(c => { if (c > maxCount) maxCount = c; }); });

            const getHeatClass = (count) => {
                if (count === 0) return 'heat-0';
                const ratio = count / maxCount;
                if (ratio < 0.1) return 'heat-1';
                if (ratio < 0.25) return 'heat-2';
                if (ratio < 0.5) return 'heat-3';
                if (ratio < 0.75) return 'heat-4';
                return 'heat-5';
            };

            // Desktop table
            const headerRow = `<tr><th>Reporter</th>${teams.map(t => `<th title="${t}">${TEAM_ABBREV[t]}</th>`).join('')}</tr>`;
            const dataRows = heatData.map(d => {
                const cells = teams.map(t => {
                    const count = d.teamCounts[t];
                    return `<td class="${getHeatClass(count)}" title="${d.reporter.name}: ${count} rumors about ${t}">${count || '-'}</td>`;
                }).join('');
                return `<tr><td onclick="openProfile('${d.reporter.id}')" style="cursor:pointer">${d.reporter.name}</td>${cells}</tr>`;
            }).join('');
            document.getElementById('heatmap-table').innerHTML = headerRow + dataRows;

            // Mobile cards
            const mobileHtml = heatData.map(d => {
                const topTeams = Object.entries(d.teamCounts)
                    .filter(([_, count]) => count > 0)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                return `
                    <div class="heatmap-card" onclick="openProfile('${d.reporter.id}')">
                        <div class="heatmap-card-header">${d.reporter.name}</div>
                        <div class="heatmap-card-teams">
                            ${topTeams.map(([team, count]) => `
                                <span class="heatmap-team-badge ${getHeatClass(count)}">
                                    <span class="team-abbr">${TEAM_ABBREV[team]}</span>
                                    <span class="team-count">${count}</span>
                                </span>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
            document.getElementById('heatmap-mobile').innerHTML = mobileHtml;
        }

        function renderOutlets() {
            const stats = getOutletStats().sort((a, b) => b.filteredTotal - a.filteredTotal).slice(0, 30);
            document.getElementById('outlets-list').innerHTML = stats.length > 0
                ? stats.map((o, i) => `
                    <div class="reporter-row">
                        <div class="rank ${i < 3 ? `rank-${i+1}` : 'rank-default'}">${i + 1}</div>
                        <div class="reporter-info"><div class="reporter-name">${o.name}</div><div class="reporter-outlet">Media Outlet</div></div>
                        <div class="reporter-stat"><div class="reporter-stat-value">${o.filteredTotal.toLocaleString()}</div><div class="reporter-stat-label">Rumors</div></div>
                    </div>
                `).join('')
                : '<div class="loading">No outlet data</div>';
        }

        // =============================================
        // REPORTER PROFILE
        // =============================================

        function openProfile(reporterId) {
            const reporter = REPORTERS.find(r => r.id === reporterId);
            if (!reporter) return;

            currentProfileId = reporterId;

            document.getElementById('main-content').style.display = 'none';
            document.getElementById('profile-page').classList.add('active');

            document.getElementById('profile-avatar').textContent = reporter.avatar;
            document.getElementById('profile-name').textContent = reporter.name;
            document.getElementById('profile-outlet').textContent = reporter.outlet;
            document.getElementById('profile-tier').textContent = `Tier ${reporter.tier}`;
            document.getElementById('profile-tier').className = `tier-badge tier-${reporter.tier}`;

            document.getElementById('profile-week').textContent = getFilteredCount(reporter.byDate, 7).toLocaleString();
            document.getElementById('profile-month').textContent = getFilteredCount(reporter.byDate, 30).toLocaleString();
            document.getElementById('profile-3mo').textContent = getFilteredCount(reporter.byDate, 90).toLocaleString();
            document.getElementById('profile-6mo').textContent = getFilteredCount(reporter.byDate, 180).toLocaleString();
            document.getElementById('profile-year').textContent = getFilteredCount(reporter.byDate, 365).toLocaleString();
            document.getElementById('profile-total').textContent = reporter.total.toLocaleString();

            renderTimelineChart(reporter);
            updateProfileCoverage(reporter);

            window.scrollTo(0, 0);
        }

        function renderTimelineChart(reporter) {
            const byDate = reporter.byDate || {};
            const dates = Object.keys(byDate).sort();
            if (dates.length === 0) {
                document.getElementById('timeline-chart').innerHTML = '<div class="loading">No timeline data</div>';
                document.getElementById('timeline-labels').innerHTML = '';
                return;
            }

            const byYear = {};
            for (const [date, count] of Object.entries(byDate)) {
                const year = date.substring(0, 4);
                byYear[year] = (byYear[year] || 0) + count;
            }

            const years = Object.keys(byYear).sort();
            const maxCount = Math.max(...Object.values(byYear));

            document.getElementById('timeline-chart').innerHTML = years.map(year => {
                const count = byYear[year];
                const height = maxCount > 0 ? Math.max(5, (count / maxCount) * 100) : 5;
                return `<div class="timeline-bar" style="height: ${height}%" data-tooltip="${year}: ${count} rumors"></div>`;
            }).join('');

            document.getElementById('timeline-labels').innerHTML = years.map(y => `<span>${y}</span>`).join('');
        }

        function updateProfileCoverage(reporter) {
            if (!reporter) {
                reporter = REPORTERS.find(r => r.id === currentProfileId);
                if (!reporter) return;
            }

            const days = currentDays;

            // Top 30 teams - clickable
            const topTeams = Object.entries(reporter.byTeam || {})
                .map(([team, count]) => [team, days === 0 ? count : getProportionalCount(count, reporter.byDate, days)])
                .filter(([_, count]) => count > 0)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 30);

            document.getElementById('profile-teams-list').innerHTML = topTeams.length > 0
                ? `<div class="coverage-grid">${topTeams.map(([team, count]) => `
                    <div class="coverage-item" onclick="showRumorsModal('${reporter.id}', 'team', '${team}')">
                        <span class="name">${team}</span><span class="count">${count}</span>
                    </div>`).join('')}</div>`
                : '<div class="loading">No team data</div>';

            // Top 30 players - clickable
            const topPlayers = Object.entries(reporter.byPlayer || {})
                .map(([player, count]) => [player, days === 0 ? count : getProportionalCount(count, reporter.byDate, days)])
                .filter(([_, count]) => count > 0)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 30);

            document.getElementById('profile-players-list').innerHTML = topPlayers.length > 0
                ? `<div class="coverage-grid">${topPlayers.map(([player, count]) => `
                    <div class="coverage-item" onclick="showRumorsModal('${reporter.id}', 'player', '${player.replace(/'/g, "\\'")}')">
                        <span class="name">${player}</span><span class="count">${count}</span>
                    </div>`).join('')}</div>`
                : '<div class="loading">No player data</div>';

            // Top 10 agents - clickable
            const topAgents = Object.entries(reporter.byAgent || {})
                .map(([agent, count]) => [agent, days === 0 ? count : getProportionalCount(count, reporter.byDate, days)])
                .filter(([_, count]) => count > 0)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);

            document.getElementById('profile-agents-list').innerHTML = topAgents.length > 0
                ? `<div class="coverage-grid">${topAgents.map(([agent, count]) => `
                    <div class="coverage-item" onclick="showRumorsModal('${reporter.id}', 'agent', '${agent.replace(/'/g, "\\'")}')">
                        <span class="name">${agent}</span><span class="count">${count}</span>
                    </div>`).join('')}</div>`
                : '<div class="loading">No agent data yet</div>';
        }

        function closeProfile() {
            document.getElementById('profile-page').classList.remove('active');
            document.getElementById('main-content').style.display = 'block';
            currentProfileId = null;
        }

        // =============================================
        // VIEW SWITCHING
        // =============================================

        function renderCurrentView() {
            updatePeriodLabel();
            
            if (currentProfileId) {
                updateProfileCoverage();
                return;
            }
            
            switch(currentView) {
                case 'leaderboard': renderLeaderboard(); break;
                case 'teams': renderTeams(); break;
                case 'players': renderPlayers(); break;
                case 'heatmap': renderHeatmap(); break;
                case 'outlets': renderOutlets(); break;
            }
        }

        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
                tab.classList.add('active');
                currentView = tab.dataset.view;
                document.getElementById(currentView).classList.add('active');
                closeProfile();
                renderCurrentView();
            });
        });

        document.querySelectorAll('.time-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentDays = parseInt(btn.dataset.days);
                renderCurrentView();
            });
        });

        // =============================================
        // INIT
        // =============================================

        document.addEventListener('DOMContentLoaded', () => {
            if (initializeData()) renderCurrentView();
            else document.getElementById('leaderboard-list').innerHTML = '<div class="loading">Failed to load data</div>';
        });
    </script>
</body>
</html>
