name: Update Reporter Rankings

on:
  # Run every 6 hours
  schedule:
    - cron: '0 */6 * * *'
  
  # Allow manual trigger
  workflow_dispatch:
  
  # Run on push to main
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  update-rankings:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout this repo
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          pip install requests python-dateutil
      
      - name: Fetch archive data from hoopshype-rumors repo
        run: |
          echo "Fetching rumors data..."
          
          # Create data directory
          mkdir -p data
          
          # Fetch all parts for comprehensive data
          for part in 1 2 3 4 5; do
            echo "Fetching part${part}..."
            curl -sL "https://jsierrahoopshype.github.io/hoopshype-rumors/hoopshype_rumors_part${part}.json" -o "data/part${part}.json"
            
            # Check if download succeeded
            if [ -s "data/part${part}.json" ]; then
              SIZE=$(wc -c < "data/part${part}.json")
              echo "✓ Downloaded part${part}.json (${SIZE} bytes)"
            else
              echo "✗ Failed to download part${part}.json (or empty)"
              rm -f "data/part${part}.json"
            fi
          done
          
          echo "Download complete!"
          ls -la data/
      
      - name: Merge archive data
        run: |
          python3 << 'EOF'
          import json
          import os

          # Load all available parts
          all_rumors = []
          data_dir = 'data'

          for filename in sorted(os.listdir(data_dir)):
              if filename.endswith('.json'):
                  filepath = os.path.join(data_dir, filename)
                  try:
                      with open(filepath, 'r', encoding='utf-8') as f:
                          data = json.load(f)
                          if isinstance(data, list):
                              all_rumors.extend(data)
                              print(f"Loaded {len(data)} rumors from {filename}")
                  except Exception as e:
                      print(f"Error loading {filename}: {e}")

          # Remove duplicates based on text content
          seen = set()
          unique_rumors = []
          for r in all_rumors:
              text = r.get('text', '')[:100]  # Use first 100 chars as key
              if text and text not in seen:
                  seen.add(text)
                  unique_rumors.append(r)

          print(f"\nTotal rumors loaded: {len(all_rumors)}")
          print(f"Unique rumors: {len(unique_rumors)}")

          # Sort by archive_date descending (newest first)
          unique_rumors.sort(key=lambda x: x.get('archive_date', ''), reverse=True)

          # Save merged file
          with open('data/merged_archive.json', 'w', encoding='utf-8') as f:
              json.dump(unique_rumors, f)

          print(f"Saved merged archive with {len(unique_rumors)} rumors")
          
          # Show date range
          if unique_rumors:
              dates = [r.get('archive_date', '') for r in unique_rumors if r.get('archive_date')]
              if dates:
                  print(f"Date range: {min(dates)} to {max(dates)}")
          EOF
      
      - name: Generate reporter rankings data
        run: |
          python3 process_archive.py data/merged_archive.json -o reporter_data.js --json
      
      - name: Update timestamp
        run: |
          echo "Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > last_updated.txt
          cat last_updated.txt
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Add all generated files
          git add reporter_data.js reporter_data.json last_updated.txt
          
          # Check if there are changes
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update reporter rankings data - $(date -u '+%Y-%m-%d %H:%M')"
            git push
          fi
      
      - name: Summary
        run: |
          echo "## Reporter Rankings Update Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Updated:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          if [ -f reporter_data.json ]; then
            REPORTERS=$(python3 -c "import json; d=json.load(open('reporter_data.json')); print(d.get('total_reporters', 'N/A'))")
            OUTLETS=$(python3 -c "import json; d=json.load(open('reporter_data.json')); print(d.get('total_outlets', 'N/A'))")
            RUMORS=$(python3 -c "import json; d=json.load(open('reporter_data.json')); print(d.get('processed_rumors', 'N/A'))")
            echo "- **Reporters tracked:** $REPORTERS" >> $GITHUB_STEP_SUMMARY
            echo "- **Outlets tracked:** $OUTLETS" >> $GITHUB_STEP_SUMMARY
            echo "- **Rumors processed:** $RUMORS" >> $GITHUB_STEP_SUMMARY
          fi
