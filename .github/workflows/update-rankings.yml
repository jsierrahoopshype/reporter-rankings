name: Update Reporter Rankings
on:
  schedule:
    # Run every 6 hours
    - cron: '0 0,6,12,18 * * *'
  workflow_dispatch:  # Allow manual triggers
  push:
    paths:
      - 'process_archive.py'
      - '.github/workflows/update-rankings.yml'
jobs:
  update-rankings:
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up job
      run: echo "Starting reporter rankings update..."
    
    - name: Checkout this repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: pip install requests
    
    - name: Fetch archive data from hoopshype-rumors repo
      run: |
        mkdir -p data
        # Fetch all archive chunks
        for i in {0..20}; do
          url="https://raw.githubusercontent.com/jsierrahoopshype/hoopshype-rumors/main/archive/rumors_chunk_${i}.json"
          if curl --fail -sL "$url" -o "data/rumors_chunk_${i}.json" 2>/dev/null; then
            echo "Downloaded chunk $i"
          else
            echo "Chunk $i not found, stopping"
            break
          fi
        done
    
    - name: Merge archive data
      run: |
        python3 << 'EOF'
        import json
        import glob
        
        all_rumors = []
        for f in sorted(glob.glob('data/rumors_chunk_*.json')):
            with open(f) as file:
                all_rumors.extend(json.load(file))
        
        with open('data/full_archive.json', 'w') as f:
            json.dump(all_rumors, f)
        
        print(f"Merged {len(all_rumors)} total rumors")
        EOF
    
    - name: Generate reporter rankings data
      run: python process_archive.py data/full_archive.json
    
    - name: Update timestamp
      run: |
        echo "Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > last_updated.txt
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add reporter_data.js last_updated.txt
        git diff --staged --quiet || git commit -m "Update reporter rankings data - $(date -u '+%Y-%m-%d %H:%M')"
        git pull --rebase origin main || true
        git push origin main || git push --force origin main
