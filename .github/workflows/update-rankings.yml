name: Update Reporter Rankings
on:
  schedule:
    - cron: '0 0,6,12,18 * * *'
  workflow_dispatch:
  push:
    paths:
      - 'process_archive.py'
      - '.github/workflows/update-rankings.yml'
jobs:
  update-rankings:
    runs-on: ubuntu-latest
    
    steps:
    - name: Set up job
      run: echo "Starting reporter rankings update..."
    
    - name: Checkout this repo
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: pip install requests
    
    - name: Fetch archive data from hoopshype-rumors repo
      run: |
        mkdir -p data
        # Fetch all archive parts (1-10)
        for i in {1..10}; do
          url="https://raw.githubusercontent.com/jsierrahoopshype/hoopshype-rumors/main/hoopshype_rumors_part${i}.json"
          if curl --fail -sL "$url" -o "data/hoopshype_rumors_part${i}.json" 2>/dev/null; then
            echo "Downloaded part $i"
          else
            echo "Part $i not found, stopping parts download"
            break
          fi
        done
        # Also fetch the latest rumors file
        url="https://raw.githubusercontent.com/jsierrahoopshype/hoopshype-rumors/main/hoopshype_rumors_latest.json"
        if curl --fail -sL "$url" -o "data/hoopshype_rumors_latest.json" 2>/dev/null; then
          echo "Downloaded latest rumors"
        else
          echo "Latest rumors file not found"
        fi
    
    - name: Merge archive data
      run: |
        python3 << 'EOF'
        import json
        import glob
        
        all_rumors = []
        # Load all part files
        for f in sorted(glob.glob('data/hoopshype_rumors_part*.json')):
            with open(f) as file:
                all_rumors.extend(json.load(file))
        
        # Load latest rumors if exists
        try:
            with open('data/hoopshype_rumors_latest.json') as file:
                latest = json.load(file)
                all_rumors.extend(latest)
                print(f"Added {len(latest)} latest rumors")
        except FileNotFoundError:
            print("No latest rumors file found")
        
        with open('data/full_archive.json', 'w') as f:
            json.dump(all_rumors, f)
        
        print(f"Merged {len(all_rumors)} total rumors")
        EOF
    
    - name: Generate reporter rankings data
      run: python process_archive.py data/full_archive.json
    
    - name: Update timestamp
      run: |
        echo "Last updated: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" > last_updated.txt
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add reporter_data.js last_updated.txt
        git diff --staged --quiet || git commit -m "Update reporter rankings data - $(date -u '+%Y-%m-%d %H:%M')"
        git pull --rebase origin main || true
        git push origin main || git push --force origin main
